/**
 * The MIT License (MIT)
 * Copyright (c) 2017-present Dmitry Soshnikov <dmitry.soshnikov@gmail.com>
 */

'use strict';

const transform = require('../transform');
const optimizationTransforms = require('./transforms');

module.exports = {
  /**
   * Optimizer transforms a regular expression into an optimized version,
   * replacing some sub-expressions with their idiomatic patterns.
   *
   * @param string | RegExp | AST - a regexp to optimize.
   *
   * @return TransformResult - an optimized regexp.
   *
   * Example:
   *
   *   /[a-zA-Z_0-9][a-zA-Z_0-9]*\e{1,}/
   *
   * Optimized to:
   *
   *   /\w+e+/
   */
  optimize(regexp) {
    let prevResult;
    let result;
    do {
      if (result) {
        prevResult = result.toRegExp().toString();
        regexp = result.toRegExp();
      }
      optimizationTransforms.forEach(transformer => {
        result = transform.transform(regexp, transformer);
        regexp = result.getAST();
      });
    } while (result.toRegExp().toString() !== prevResult);

    return result;
  },
};